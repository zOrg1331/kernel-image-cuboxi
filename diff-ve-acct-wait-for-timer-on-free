X-Account-Key: account4
X-UIDL: 2a430da5d2b30c42
X-Mozilla-Status: 0001
X-Mozilla-Status2: 00000000
X-Mozilla-Keys:                                                                                 
Received: from relay.parallels.com (relay.parallels.com [195.214.232.42])
	by relay.sw.ru (8.13.4/8.13.4) with ESMTP id o2OICIsn021136
	(version=TLSv1/SSLv3 cipher=DHE-RSA-AES256-SHA bits=256 verify=NO);
	Wed, 24 Mar 2010 21:12:19 +0300 (MSK)
Received: from mx1.parallels.com ([64.131.89.18])
	by relay.parallels.com with esmtps (TLSv1:AES256-SHA:256)
	(Exim 4.71)
	(envelope-from <vgusev@openvz.org>)
	id 1NuV3x-0008JI-C4; Wed, 24 Mar 2010 21:12:17 +0300
Received: from mailhub.sw.ru ([195.214.232.25] helo=relay.sw.ru)
	by mx1.parallels.com with esmtps (TLSv1:AES256-SHA:256)
	(Exim 4.71)
	(envelope-from <vgusev@openvz.org>)
	id 1NuV3w-00048S-F0; Wed, 24 Mar 2010 14:12:16 -0400
Received: from localhost.localdomain ([10.30.18.218])
	by relay.sw.ru (8.13.4/8.13.4) with ESMTP id o2OIC3cw007235;
	Wed, 24 Mar 2010 21:12:14 +0300 (MSK)
From: Vitaliy Gusev <vgusev@openvz.org>
To: xemul@openvz.org
Cc: vz@lists.sw.ru, Vitaliy Gusev <vgusev@openvz.org>
Subject: [2.6.18][PATCH 8/8] pacct: wait for grace period before kfree(acct)
Date: Wed, 24 Mar 2010 21:17:29 +0300
Message-Id: <1269454649-887-9-git-send-email-vgusev@openvz.org>
X-Mailer: git-send-email 1.6.0.2
In-Reply-To: <1269454649-887-1-git-send-email-vgusev@openvz.org>
References: <1269454649-887-1-git-send-email-vgusev@openvz.org>

timer_del() doesn't guarantee that timer handler are not executed now.
Therefore acct_timeout can refer to deallocated memory.

Signed-off-by: Vitaliy Gusev <vgusev@openvz.org>
---
 kernel/acct.c |    8 +++++---
 1 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/kernel/acct.c b/kernel/acct.c
index 4225e4c..e507010 100644
--- a/kernel/acct.c
+++ b/kernel/acct.c
@@ -58,6 +58,7 @@
 #include <asm/uaccess.h>
 #include <asm/div64.h>
 #include <linux/blkdev.h> /* sector_div */
+#include <linux/rcupdate.h>
 
 /*
  * These constants control the amount of freespace that suspend and
@@ -573,11 +574,12 @@ void acct_exit_ve(struct bsd_acct_struct *acct)
 		return;
 
 	spin_lock(&acct_lock);
-	if (acct->file) {
+	if (acct->file)
 		acct_file_reopen(acct, NULL);
-		kfree(acct);
-	}
 	spin_unlock(&acct_lock);
+
+	synchronize_rcu();
+	kfree(acct);
 }
 EXPORT_SYMBOL(acct_exit_ve);
 
-- 
1.6.0.2


