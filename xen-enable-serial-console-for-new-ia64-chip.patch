From: Bill Burns <bburns@redhat.com>
Date: Wed, 2 Jul 2008 13:43:24 -0400
Subject: [xen] enable serial console for new ia64 chip
Message-id: 20080702174324.8165.65599.sendpatchset@localhost.localdomain
O-Subject: [RHEL5.3 PATCH 1/3]
Bugzilla: 437096
RH-Acked-by: Jarod Wilson <jwilson@redhat.com>

Fixes bz 437096

Problem description:
This Intel feature patch adds support for VT-i2.
VT-i2 supports the new hardware virtualization features of a new
ia64 processor. This processor will be used on the upcoming Tukwila
system.

Patches were provided by Intel. They apply cleanly
to our 3.1.2 based code base and brew build cleanly.

Upstream in Xen Unstable:
http://xenbits.xensource.com/xen-unstable.hg?rev/e5244d14486c
http://xenbits.xensource.com/xen-unstable.hg?rev/6cf504b4de7d

Brew build:
http://brewweb.devel.redhat.com/brew/taskinfo?taskID=1372513

Testing:
Partner testing ongoing.

Please review and ACK.

Thanks,
 Bill

diff --git a/arch/ia64/linux-xen/setup.c b/arch/ia64/linux-xen/setup.c
index 01ebf1f..44ad754 100644
--- a/arch/ia64/linux-xen/setup.c
+++ b/arch/ia64/linux-xen/setup.c
@@ -368,16 +368,21 @@ acpi_oem_console_setup(void)
 	 * Tiger 2: SR870BH2
 	 * Tiger 4: SR870BN4
 	 */
-	if (strncmp(hdr->oem_id, "INTEL", 5) ||
-	    (!strncmp(hdr->oem_table_id, "SR870BH2", 8) &&
-	     !strncmp(hdr->oem_table_id, "SR870BN4", 8)))
-		return -ENODEV;
-
-	ns16550_com1.baud = BAUD_AUTO;
-	ns16550_com1.io_base = 0x2f8;
-	ns16550_com1.irq = 3;
-
-	return 0;
+	if (!strncmp(hdr->oem_id, "INTEL", 5)) {
+		if (!strncmp(hdr->oem_table_id, "SR870BH2", 8) ||
+		    !strncmp(hdr->oem_table_id, "SR870BN4", 8)) {
+			ns16550_com1.baud = BAUD_AUTO;
+			ns16550_com1.io_base = 0x2f8;
+			ns16550_com1.irq = 3;
+			return 0;
+		} else {
+			ns16550_com1.baud = BAUD_AUTO;
+			ns16550_com1.io_base = 0x3f8;
+			ns16550_com1.irq = ns16550_com1_gsi = 4;
+			return 0;
+		}
+	}
+	return -ENODEV;
 }
 #endif
 
