--- ./fs/compat.c.ustatfix	2009-10-27 14:53:11.000000000 +0300
+++ ./fs/compat.c	2009-10-27 15:25:38.000000000 +0300
@@ -49,6 +49,7 @@
 #include <linux/mm.h>
 #include <linux/quota.h>
 #include <linux/grsecurity.h>
+#include <linux/ve_proto.h>
 
 #include <net/sock.h>		/* siocdevprivate_ioctl */
 
@@ -523,8 +524,14 @@ asmlinkage long compat_sys_ustat(unsigne
 	struct compat_ustat tmp;
 	struct kstatfs sbuf;
 	int err;
+	dev_t kdev;
 
-	sb = user_get_super(new_decode_dev(dev));
+	kdev = new_decode_dev(dev);
+	err = get_device_perms_ve(S_IFBLK, kdev, FMODE_READ);
+	if (err)
+		return err;
+
+	sb = user_get_super(kdev);
 	if (!sb)
 		return -EINVAL;
 	err = vfs_statfs(sb->s_root, &sbuf);
